<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>éŒ¦ç¹¡å…¬å¯“</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div id="start-overlay" onclick="initAudioAndStart()">
      <h1>
        éŒ¦ç¹¡å…¬å¯“<br /><span style="font-size: 0.5em; color: white"
          >éµå®ˆè¦å‰‡</span
        >
      </h1>
      <p>[ é»æ“Šè¢å¹•é€£æ¥ç¥ç¶“ä»‹é¢ ]</p>
      <div style="font-size: 0.8em; margin-top: 20px; color: #555">
        è­¦å‘Šï¼šåŒ…å«å¼·çƒˆçš„å¿ƒç†ææ€–å…ƒç´ èˆ‡æ™‚é–“å£“åŠ›
      </div>
    </div>

    <div class="vignette"></div>
    <div class="crt-overlay"></div>

    <header>
      <div class="status-group">
        <div>Day: <span id="disp-day">1</span></div>
        <div>Time: <span id="disp-time">00:00</span></div>
      </div>
      <div class="status-group">
        <div class="status-item status-sanity">
          ç²¾ç¥: <span id="disp-sanity">å†·éœ</span>
        </div>
        <div class="status-item status-stamina">
          é«”åŠ›: <span id="disp-stamina">å……æ²›</span>
        </div>
        <div class="status-item status-corruption">
          æ±¡æŸ“: <span id="disp-corruption">æ­£å¸¸</span>
        </div>
      </div>
      <div id="action-bar">
        <button class="action-btn" id="btn-cctv" onclick="CCTVSystem.open()">
          [ ç›£æ§ç³»çµ± ]
        </button>
        <button class="action-btn" onclick="openModal('rules-modal')">
          å®ˆå‰‡
        </button>
        <button class="action-btn" onclick="openModal('clues-modal')">
          ç­†è¨˜
        </button>
        <button
          class="action-btn orange-btn"
          onclick="openModal('credits-modal')"
        >
          ä½œè€…
        </button>
      </div>
    </header>

    <div id="cctv-modal" class="modal">
      <div class="modal-content">
        <span
          class="close-btn"
          style="top: 5px"
          onclick="closeModal('cctv-modal')"
          >&times;</span
        >
        <h2 style="border-bottom: 2px dashed #0f0; color: #0f0">
          SECURITY_FEED_v0.9
        </h2>

        <div id="cctv-screen">
          <div class="cctv-noise"></div>
          <div id="cctv-overlay" class="cctv-overlay">REC â—</div>
          <div id="cctv-content">ç³»çµ±å¾…æ©Ÿä¸­...<br />é¸æ“‡æ”åƒé ­æ¥å…¥ä¿¡è™Ÿ</div>
        </div>

        <div class="cam-btn-group" id="cctv-controls"></div>

        <div
          style="
            margin-top: 15px;
            border-top: 1px solid #004400;
            padding-top: 10px;
            font-size: 0.8rem;
            color: #008800;
          "
        >
          è­¦å‘Šï¼šé•·æ™‚é–“æ³¨è¦–ç›£æ§ç•«é¢å¯èƒ½å°è‡´ç²¾ç¥æŒ‡æ•¸ä¸‹é™ã€‚<br />ç™¼ç¾ç•°å¸¸è«‹ç«‹å³åŸ·è¡Œ
          [æ›´æ–°å”è­°]ã€‚
        </div>
      </div>
    </div>

    <main id="game-container">
      <div id="game-log"></div>
      <div id="panic-container">
        <div id="panic-text">PANIC</div>
        <div id="panic-bar"></div>
      </div>
      <div id="choices-area"></div>
    </main>

    <div id="rules-modal" class="modal">
      <div class="modal-content">
        <span class="close-btn" onclick="closeModal('rules-modal')"
          >&times;</span
        >
        <h2>ç‰©æ¥­å®‰å…¨ç®¡ç†è¦ç¯„ (v2.4)</h2>
        <div style="font-size: 0.8em; color: #666; margin-bottom: 10px">
          è«‹åš´æ ¼åŸ·è¡Œä»¥ç¢ºä¿å‹å·¥å®‰å…¨èˆ‡æ¬Šç›Šã€‚
        </div>
        <ul id="rules-list" class="rule-list"></ul>
      </div>
    </div>

    <div id="clues-modal" class="modal">
      <div class="modal-content">
        <span class="close-btn" onclick="closeModal('clues-modal')"
          >&times;</span
        >
        <h2>èª¿æŸ¥ç­†è¨˜èˆ‡ç‰©å“</h2>
        <ul id="clues-list" class="rule-list">
          <li style="color: #666">ç›®å‰å£è¢‹ç©ºç©ºå¦‚ä¹Ÿã€‚</li>
        </ul>
      </div>
    </div>

    <div id="credits-modal" class="modal">
      <div class="modal-content">
        <span class="close-btn" onclick="closeModal('credits-modal')"
          >&times;</span
        >
        <h2>ğŸ‘¨â€ğŸ’» ä½œè€…åå–®</h2>
        <div
          style="
            font-size: 0.9em;
            color: #aaa;
            margin-bottom: 20px;
            line-height: 1.5;
          "
        >
          æ„Ÿè¬éŠç©ï¼æ­¡è¿é—œæ³¨æˆ‘çš„ç¤¾ç¾¤ä»¥ç²å¾—æœ€æ–°è³‡è¨Šã€‚
        </div>

        <div style="display: flex; flex-direction: column; gap: 15px">
          <a
            href="https://www.threads.net/@kanda_shota_art?igshid=NTc4MTIwNjQ2YQ=="
            target="_blank"
            style="text-decoration: none"
          >
            <button
              style="
                width: 100%;
                padding: 15px;
                background: #111;
                color: #fff;
                border: 1px solid #333;
                cursor: pointer;
                font-family: inherit;
              "
            >
              <span>â—‰</span> Threads (@kanda_shota_art)
            </button>
          </a>

          <a
            href="https://x.com/shota_at_?s=21"
            target="_blank"
            style="text-decoration: none"
          >
            <button
              style="
                width: 100%;
                padding: 15px;
                background: #000;
                color: #fff;
                border: 1px solid #333;
                cursor: pointer;
                font-family: inherit;
              "
            >
              <span>ğ•</span> Twitter (X)
            </button>
          </a>

          <a
            href="https://www.buymeacoffee.com/maker.shota"
            target="_blank"
            style="text-decoration: none"
          >
            <button class="support-btn"><span>âš”ï¸</span> è´ŠåŠ©æˆ‘å‰é€²</button>
          </a>
        </div>
      </div>
    </div>

    <script type="module">
      // --- éŸ³æ•ˆç³»çµ± (Web Audio API) ---
      import { SoundSystem } from "./System/SoundSystem.js";
      // --- éŠæˆ²æ ¸å¿ƒæ•¸æ“š ---
      import { GameState } from "./Config/GameState.js";

      import { CCTVSystem } from "./System/CCTVSystem.js";

      import {
        log,
        changeStat,
        typeWriter,
        updateUI,
        updateVisualFilters,
        checkDeath,
        gameOver,
      } from "./Utils/GameUtils.js";

      // --- ææ…Œèˆ‡å€’æ•¸ç³»çµ± ---
      import { PanicSystem } from "./System/PanicSystem.js";

      // --- è¦å‰‡è³‡æ–™åº« (ä¿®æ­£å¾Œç‰ˆæœ¬) ---
      import { RulesDB } from "./DataBase/RulesDB.js";
      import { CluesDB } from "./DataBase/CluesDB.js";

      // Library
      import { CorruptionEventLibrary } from "./Library/CorruptionEventLibrary.js";
      import { EventLibrary } from "./Library/EventLibrary.js";

      // --- æ ¸å¿ƒèˆ‡è¼”åŠ©å‡½æ•¸ ---

      function initAudioAndStart() {
        SoundSystem.init();
        document.getElementById("start-overlay").style.display = "none";

        const startArea = document.getElementById("choices-area");
        startArea.innerHTML = "";

        // ç¬¬ä¸€æ®µï¼šç³»çµ±è¼‰å…¥
        setTimeout(() => {
          log(
            "ç³»çµ±åˆå§‹åŒ–... æª”æ¡ˆç·¨è™Ÿ JINXIU-ABYSS v6.0 è¼‰å…¥å®Œç•¢ã€‚",
            "system",
            () => {
              SoundSystem.play("glitch");

              // ç¬¬äºŒæ®µï¼šå‰æƒ…æè¦ï¼ˆç‚ºä»€éº¼ä¾†é€™è£¡ï¼‰
              log(
                "<br>ç‚ºäº†å„Ÿé‚„é‚£ç­†ä¸è©²æ¬ ä¸‹çš„é‰…é¡è³­å‚µï¼Œä½ èµ°æŠ•ç„¡è·¯ï¼Œæ’•ä¸‹äº†é›»ç·šæ¡¿ä¸Šé‚£å¼µæ³›é»ƒçš„æ‹›å‹Ÿå–®ã€‚<br>ä¸Šé¢å¯«è‘—ï¼šã€<b>é«˜è–ªæ€¥å¾µå¤œç­ä¿å…¨ã€‚æ—¥çµä¸‰è¬ã€‚ä¸å•ç¶“æ­·ã€‚</b>ã€",
                "event",
                () => {
                  // ç¬¬ä¸‰æ®µï¼šé¢è©¦å›æ†¶
                  setTimeout(() => {
                    log(
                      "é¢è©¦å®˜å…¨ç¨‹èƒŒå°è‘—ä½ ï¼Œè²éŸ³åƒæ˜¯æŒ‡ç”²åˆ®éé»‘æ¿ä¸€æ¨£åˆºè€³ï¼š<br>ã€é€™è£¡æœ‰é»è€èˆŠéª¯é«’ï¼Œä½†éŒ¢å¾ˆä¹¾æ·¨ã€‚åªè¦ä½ èƒ½<b>åš´æ ¼éµå®ˆå®ˆå‰‡</b>ï¼Œå¶çˆ¾çœ‹çœ‹ç›£æ§ï¼Œå·¥ä½œä¸ƒå¤©å¾Œé€™äº›éŒ¢å°±æ˜¯ä½ çš„ã€‚ã€",
                      "event",
                      () => {
                        // ç¬¬å››æ®µï¼šç¾åœ¨ç‹€æ³
                        setTimeout(() => {
                          log(
                            "<br>ç¾åœ¨æ˜¯åˆå¤œ0é»ã€‚ä½ ååœ¨å†°å†·çš„ä¿å®‰å®¤è£¡ï¼Œèº«å¾Œçš„éµé–€å·²ç¶“è‡ªå‹•ä¸Šé–ã€‚<br>çœ‹è‘—æ¡Œä¸Šçš„å®ˆå‰‡ï¼Œä½ çŸ¥é“è‡ªå·±æ²’æœ‰é€€è·¯äº†ã€‚",
                            "danger",
                            () => {
                              createButton("é–‹å§‹å€¼ç­", () => {
                                startGame();
                              });
                              startArea.classList.add("show");
                            }
                          );
                        }, 2000); // åœé “ä¹…ä¸€é»è®“ç©å®¶é–±è®€
                      }
                    );
                  }, 1500);
                }
              );
            }
          );
        }, 500);
      }

      // è¦–è¦ºæ¬ºè©ï¼šæ··æ·†æ–‡æœ¬
      function scrambleText(text) {
        const chars = "!@#$%^&*()_+{}|:<>?";
        let newText = "";
        for (let i = 0; i < text.length; i++) {
          if (Math.random() < 0.4) {
            newText += chars[Math.floor(Math.random() * chars.length)];
          } else {
            newText += text[i];
          }
        }
        return newText;
      }

      function createButton(text, onClick, isInsane = false, isRest = false) {
        const btn = document.createElement("button");
        let displayText = text;

        // --- Meta Horror: æ–‡å­—ç¯¡æ”¹ ---
        // ç•¶ç†æ™ºä½æ™‚ï¼ŒæŒ‰éˆ•æ–‡å­—å¯èƒ½æœƒæ’’è¬Š
        if (GameState.sanity < 30 && Math.random() < 0.3) {
          const corruptedWords = [
            "åˆ¥æŒ‰",
            "é‚£æ˜¯é™·é˜±",
            "æ•‘å‘½",
            "å¥½ç—›",
            "è®“æˆ‘é€²å»",
          ];
          displayText =
            corruptedWords[Math.floor(Math.random() * corruptedWords.length)];
          btn.classList.add("btn-glitch-text");
        } else if (GameState.sanity < 50 && Math.random() < 0.4) {
          displayText = scrambleText(text);
        }

        btn.innerText = displayText;

        if (isInsane) btn.className = "choice-insane";
        if (isRest) btn.className = "choice-rest";

        // --- Meta Horror: è¦–è¦ºå¹²æ“¾ ---
        if (GameState.sanity < 40 && Math.random() < 0.5)
          btn.classList.add("btn-shake");
        if (GameState.sanity < 60 && Math.random() < 0.3)
          btn.classList.add("btn-blur");

        // --- Meta Horror: é€ƒè·‘çš„æŒ‰éˆ• (æ–°å¢åŠŸèƒ½ - æ‰‹æ©Ÿä¿®å¾©ç‰ˆ) ---
        if (isRest && GameState.corruption > 60) {
          // å®šç¾©é€ƒè·‘è¡Œç‚º
          const runAway = function (e) {
            // å¦‚æœæ˜¯è§¸æ§äº‹ä»¶ï¼Œé˜»æ­¢é è¨­é»æ“Šè¡Œç‚º
            if (e && e.type === "touchstart") {
              e.preventDefault();
              e.stopPropagation(); // é˜»æ­¢å†’æ³¡ï¼Œç¢ºä¿ä¸æœƒè§¸ç™¼ click
            }

            // æŒ‰éˆ•éš¨æ©Ÿè·³å‹•ä½ç½® (æ‰‹æ©Ÿä¸Šç¯„åœå°ä¸€é»ï¼Œé¿å…è·‘å‡ºè¢å¹•)
            const range = window.innerWidth < 600 ? 100 : 200;
            const x = (Math.random() - 0.5) * range;
            const y = (Math.random() - 0.5) * range;

            this.style.transform = `translate(${x}px, ${y}px)`;
            this.style.borderColor = "red";
            this.innerText = "ä½ ä¸é…ä¼‘æ¯";
            SoundSystem.play("type"); // åŠ å€‹è²éŸ³å¢åŠ åš‡äººæ•ˆæœ
          };

          btn.onmouseover = runAway; // é›»è…¦ç‰ˆ
          btn.ontouchstart = runAway; // æ‰‹æ©Ÿç‰ˆ
        }

        btn.onmouseenter = () => SoundSystem.play("hover");
        btn.onclick = () => {
          PanicSystem.stop();
          SoundSystem.play("click");
          // æ¸…é™¤æ‰€æœ‰æŒ‰éˆ•çš„ä½ç§»æ•ˆæœ
          const allBtns = document.querySelectorAll("#choices-area button");
          allBtns.forEach((b) => {
            b.disabled = true;
            b.style.transform = "none";
          });
          onClick();
        };

        document.getElementById("choices-area").appendChild(btn);
        return btn;
      }

      function gameWin() {
        GameState.isGameOver = true;
        SoundSystem.play("success");
        log(
          `<br><h1 style="color:#4caf50">çµå±€ï¼šå€–å­˜è€…</h1><p>ç¬¬ä¸ƒå¤©çš„é™½å…‰çµ‚æ–¼ç©¿é€äº†æ¿ƒéœ§ã€‚ä½ æ´»ä¸‹ä¾†äº†ã€‚<br>ä½†æ¯ç•¶å¤œæ·±äººéœï¼Œä½ ç¸½è¦ºå¾—æœ‰äººåœ¨èƒŒå¾Œçœ‹è‘—ä½ ã€‚</p>`,
          "success",
          () => {
            document.getElementById(
              "choices-area"
            ).innerHTML = `<button onclick="location.reload()">å†æ¬¡æŒ‘æˆ°</button>`;
            document.getElementById("choices-area").classList.add("show");
          }
        );
      }

      // --- æ¨¡æ…‹çª—æ§åˆ¶ ---
      window.openModal = function (id) {
        SoundSystem.play("hover");
        document.getElementById(id).style.display = "flex";
        if (id === "rules-modal") renderRules();
        if (id === "clues-modal") renderClues();
      };
      window.closeModal = function (id) {
        SoundSystem.play("click");
        document.getElementById(id).style.display = "none";
      };

      function renderRules() {
        const list = document.getElementById("rules-list");
        list.innerHTML = "";

        RulesDB.forEach((rule, index) => {
          const li = document.createElement("li");
          let content = `<b>${rule.id}.</b> `;

          // å–å¾—ç•¶å‰ç†æ™º
          const s = GameState.sanity;

          // --- æ¼¸é€²å¼å´©å£é‚è¼¯ ---

          // 1. ç˜‹ç‹‚æ©Ÿç‡ (Insane Text):
          // åªæœ‰ç•¶ç†æ™ºä½æ–¼ 40 æ™‚æ‰é–‹å§‹æœ‰å¯èƒ½å‡ºç¾ã€‚
          // éš¨è‘—ç†æ™ºå¾ 40 é™åˆ° 0ï¼Œæ©Ÿç‡å¾ 0% æå‡åˆ° 80%
          let insaneChance = 0;
          if (s < 40) {
            insaneChance = (40 - s) / 50;
          }

          // 2. æ‰­æ›²æ©Ÿç‡ (Distorted Text):
          // ç†æ™ºä½æ–¼ 80 é–‹å§‹å‡ºç¾ã€‚
          // éš¨è‘—ç†æ™ºå¾ 80 é™åˆ° 0ï¼Œæ©Ÿç‡å¾ 0% æå‡åˆ° 100%
          let distortedChance = 0;
          if (s < 80) {
            distortedChance = (80 - s) / 80;
          }

          // 3. æ¬Šé‡ä¿®æ­£ï¼šè¶Šå¾Œé¢çš„è¦å‰‡ (index è¶Šå¤§) è¶Šå®¹æ˜“å£æ‰
          // é€™æœƒé€ æˆä¸€ç¨®ã€Œå‰é¢å¹¾æ¢é‚„å¾ˆæ­£å¸¸ï¼Œè®€åˆ°å¾Œé¢å»è¶Šä¾†è¶Šä¸å°å‹ã€çš„ææ€–æ„Ÿ
          if (s < 80) {
            distortedChance += index * 0.03;
          }

          // --- åˆ¤å®šé¡¯ç¤ºå…§å®¹ ---
          // å…ˆåˆ¤å®šæ˜¯å¦ç˜‹ç‹‚ (æœ€åš´é‡)ï¼Œå†åˆ¤å®šæ˜¯å¦æ‰­æ›²ï¼Œæœ€å¾Œæ‰æ˜¯æ­£å¸¸

          if (Math.random() < insaneChance) {
            // åš´é‡ç²¾ç¥æ±¡æŸ“ç‹€æ…‹ï¼šé¡¯ç¤ºç´…è‰²ç˜‹ç‹‚æ–‡å­—
            content += `<span class="rule-corrupted" style="font-family:Impact;">${rule.insane}</span>`;

            // è¦–è¦ºç‰¹æ•ˆï¼šè®“é€™è¡Œå­—å¾®å¾®æ­ªæ–œ
            li.style.transform = `skewX(${Math.random() * 10 - 5}deg)`;
            li.style.borderLeftColor = "#d32f2f"; // å·¦é‚Šæ¡†è®Šç´…
            li.style.background = "rgba(211, 47, 47, 0.1)";
          } else if (Math.random() < distortedChance) {
            // è¼•å¾®èªçŸ¥æ‰­æ›²ï¼šé¡¯ç¤ºç°è‰²èª˜å°æ–‡å­—
            content += `<span style="color:#bdc3c7; letter-spacing: 1px;">${rule.distorted}</span>`;
            li.style.borderLeftColor = "#777";
          } else {
            // æ­£å¸¸ç‹€æ…‹
            content += rule.original;
          }

          li.innerHTML = content;
          list.appendChild(li);
        });
      }

      function renderClues() {
        const list = document.getElementById("clues-list");
        list.innerHTML = "";
        if (GameState.clues.length === 0) {
          list.innerHTML = '<li style="color: #666;">ç›®å‰æ²’æœ‰ä»»ä½•ç·šç´¢ã€‚</li>';
          return;
        }
        GameState.clues.forEach((clueId) => {
          const li = document.createElement("li");
          li.innerText = CluesDB[clueId] || "æœªçŸ¥çš„ç¢ç‰‡";
          li.style.color = clueId.startsWith("item") ? "#ffd700" : "#aed581";
          list.appendChild(li);
        });
      }

      // --- éŠæˆ²æµç¨‹ ---
      function startGame() {
        const area = document.getElementById("choices-area");
        area.classList.remove("show");
        area.innerHTML = "";
        log("<br>--- ç¬¬ 1 å¤œ é–‹å§‹ ---", "system", () => nextTimeBlock());
      }

      function nextTimeBlock() {
        if (GameState.isGameOver) return;

        if (GameState.timeIndex >= GameState.timePoints.length) {
          endNight();
          return;
        }

        // --- æ–°å¢ï¼šçµç®—ä¸Šä¸€æ™‚æ®µæœªè™•ç†çš„å¨è„… ---
        CCTVSystem.checkUnpurgedThreats();

        // â˜…â˜…â˜… ä¿®æ­£é»ï¼šå¦‚æœçµç®—å¨è„…å¾Œå°è‡´æ­»äº¡ï¼Œç«‹å³åœæ­¢å¾ŒçºŒé‚è¼¯ â˜…â˜…â˜…
        if (GameState.isGameOver) return;

        // --- æ–°å¢ï¼šéš¨æ©Ÿç”¢ç”Ÿä¸‹ä¸€æ™‚æ®µçš„æ–°å¨è„… ---
        CCTVSystem.generatePassiveThreats();

        updateUI();
        let currentTime = GameState.timePoints[GameState.timeIndex];

        // ä¸‹æ–¹é‚è¼¯ä¿æŒä¸è®Š...
        document.getElementById("choices-area").classList.remove("show");

        log(`<br>=== æ™‚é–“ï¼š${currentTime} ===`, "system", () => {
          if (currentTime === "03:00") renderThreeAMChoice();
          else generateEvent();
        });
      }

      function renderThreeAMChoice() {
        log(
          "ç¾åœ¨æ˜¯å‡Œæ™¨3é»ã€‚å…¬å¯“é™°æ°£æœ€é‡ï¼Œä½†ä¹Ÿæ˜¯æš«æ™‚èº²é¿çš„æ©Ÿæœƒã€‚",
          "system",
          () => {
            const area = document.getElementById("choices-area");
            area.innerHTML = "";

            createButton(
              "å›åˆ°ä¿å®‰å®¤ä¼‘æ¯",
              () => {
                if (GameState.stamina < 15) {
                  area.classList.remove("show");
                  log("ä½ å¤ªç´¯äº†ï¼Œèµ°ä¸å›å»äº†...", "danger", () =>
                    generateEvent()
                  );
                  return;
                }
                area.classList.remove("show");
                log("ä½ é–ä¸Šé–€é–‰ç›®é¤Šç¥ã€‚å¤–é¢çš„è²éŸ³è¢«éš”çµ•äº†ã€‚", "success", () => {
                  changeStat("stamina", -15);
                  changeStat("sanity", 15);
                  changeStat("corruption", -10);
                  setTimeout(() => {
                    GameState.timeIndex++;
                    nextTimeBlock();
                  }, 500);
                });
              },
              false,
              true
            );

            createButton("ç¹¼çºŒå·¡é‚", () => {
              area.classList.remove("show");
              log("ä½ æ‹¿èµ·æ‰‹é›»ç­’ï¼Œç¹¼çºŒé¢å°é»‘æš—ã€‚", "event", () =>
                generateEvent()
              );
            });

            area.classList.add("show");
          }
        );
      }

      function endNight() {
        document.getElementById("choices-area").classList.remove("show");
        log(
          "<br>--- 6:00 AM ---<br>é›é³´è²éŸ¿èµ·ï¼Œä½ æ´»éäº†é€™ä¸€å¤œã€‚",
          "success",
          () => {
            GameState.usedEvents = [];
            if (GameState.day >= 7) gameWin();
            else {
              GameState.phase = "DAY";
              GameState.timeIndex = 0;
              updateUI();
              showDayPhase();
            }
          }
        );
      }

      function showDayPhase() {
        log(
          `<br>ã€ç¬¬ ${GameState.day} å¤© - ç™½å¤©ã€‘<br>åˆ©ç”¨ç™½å¤©æ¢å¾©ç‹€æ…‹ã€‚`,
          "event",
          () => {
            const area = document.getElementById("choices-area");
            area.innerHTML = "";
            createButton("æ·±å±¤ç¡çœ ", () => handleDayAction("sleep"));
            createButton("èª¿æŸ¥å…¬å¯“æ­·å²", () => handleDayAction("investigate"));
            if (GameState.corruption > 30)
              createButton("å»å¯ºå»Ÿæ‹œæ‹œ", () => handleDayAction("temple"));
            area.classList.add("show");
          }
        );
      }

      function handleDayAction(action) {
        const area = document.getElementById("choices-area");
        area.classList.remove("show");
        setTimeout(() => {
          if (action === "sleep") {
            log("ä½ åƒäº†å®‰çœ è—¥ï¼Œç¡äº†å€‹å¥½è¦ºã€‚", "success", proceedToNextNight);
            changeStat("sanity", 30);
            changeStat("stamina", 40);
          } else if (action === "investigate") {
            log("ä½ èª¿æŸ¥äº†èˆŠå ±ç´™...ç™¼ç¾äº†ä¸€äº›å¯æ€•çš„äº‹å¯¦ã€‚", "event", () => {
              changeStat("sanity", 10);
              changeStat("stamina", -10);
              changeStat("corruption", 5);
              findClue();
              proceedToNextNight();
            });
          } else if (action === "temple") {
            log(
              "è€å’Œå°šçµ¦äº†ä½ ç¬¦æ°´ã€‚ä½ æ„Ÿè¦ºè¼•é¬†äº†ä¸€äº›ã€‚",
              "success",
              proceedToNextNight
            );
            changeStat("corruption", -20);
            changeStat("stamina", -20);
          }
        }, 500);
      }

      function proceedToNextNight() {
        setTimeout(() => {
          GameState.day++;
          GameState.phase = "NIGHT";
          log(`<br>--- ç¬¬ ${GameState.day} å¤œ é–‹å§‹ ---`, "system", () =>
            nextTimeBlock()
          );
        }, 1000);
      }

      function findClue() {
        let possibleClues = [];
        if (GameState.day === 1)
          possibleClues = ["clue_404", "item_flashlight"];
        else if (GameState.day === 2)
          possibleClues = ["clue_red_lady", "clue_tie"];
        else if (GameState.day === 3)
          possibleClues = ["clue_vending", "clue_package"];
        else if (GameState.day === 4)
          possibleClues = ["clue_mirror", "item_charm"];
        else if (GameState.day >= 5)
          possibleClues = ["clue_manager", "clue_moon"];

        possibleClues = possibleClues.filter(
          (c) => !GameState.clues.includes(c)
        );
        if (possibleClues.length > 0) {
          const newClue =
            possibleClues[Math.floor(Math.random() * possibleClues.length)];
          GameState.clues.push(newClue);
          SoundSystem.play("success");
          log(`ã€ç²å¾—ã€‘ï¼š${CluesDB[newClue]}`, "success");
        } else log("ä½ ä¸€ç„¡æ‰€ç²ã€‚", "system");
      }

      function generateEvent() {
        let event = null;
        const day = GameState.day;
        const time = GameState.timePoints[GameState.timeIndex];

        // 1. å„ªå…ˆè™•ç†å›ºå®šåŠ‡æƒ…äº‹ä»¶
        if (day === 7 && time === "05:00")
          event = EventLibrary["final_confrontation"];
        else if (day === 3 && time === "01:00")
          event = EventLibrary["red_lady_encounter"];
        else if (day === 5 && time === "03:00")
          event = EventLibrary["mirror_reflection"];
        else if (day === 6 && time === "23:00")
          event = EventLibrary["blood_moon"];
        else {
          // 2. æ±™æŸ“äº‹ä»¶æª¢å®šæ©Ÿåˆ¶
          let isCorruptionEvent = false;

          if (GameState.corruption > 15) {
            const corruptionChance = GameState.corruption / 120;
            if (Math.random() < corruptionChance) {
              isCorruptionEvent = true;
            }
          }

          if (isCorruptionEvent) {
            const corrKeys = Object.keys(CorruptionEventLibrary);
            // é˜²å‘†ï¼šç¢ºä¿æ±™æŸ“äº‹ä»¶åº«æœ‰æ±è¥¿
            if (corrKeys.length > 0) {
              const randKey =
                corrKeys[Math.floor(Math.random() * corrKeys.length)];
              event = CorruptionEventLibrary[randKey];
            }
            SoundSystem.play("glitch");
          }

          // å¦‚æœä¸æ˜¯æ±™æŸ“äº‹ä»¶ï¼Œæˆ–æ±™æŸ“äº‹ä»¶æŠ“å–å¤±æ•—ï¼Œå‰‡åŸ·è¡Œæ¨™æº–äº‹ä»¶
          if (!event) {
            // 3. æ¨™æº–éš¨æ©Ÿäº‹ä»¶
            const fullPool = [
              "noise_upstairs",
              "elevator_b1",
              "phone_call",
              "vending_machine",
              "hallway_shadow",
              "strange_smell",
              "crying_baby",
              "midnight_delivery",
              "cctv_anomaly",
              "manager_visit",
              "lost_girl",
              "power_outage",
              "room_404_encounter",
              "phantom_pet",
              "glitch_anomaly",
              "neighbor_knock",
              "restock_man",
              "extra_floor",
              "red_tie_gift",
              "fake_rule_note",
              "toy_dog",
              "green_drink",
              "neighbor_405",
              "vending_purple",
              "manager_scarf",
              "elevator_mirror",
              "stray_dog_shadow",
              "vending_leaking",
              "manager_choice",
              "cleaner_green",
              "room_403_party",
              "courier_404",
              "laundry_red",
              "elevator_maintain",
              "manager_id",
              "trick_fire_check",
              "trick_blind_dog",
              "trick_elevator_voice",
              "trick_grandma_404",
              "trick_manager_reflection",
              "trick_trash_rules",
            ];

            let availablePool = fullPool.filter(
              (id) => !GameState.usedEvents.includes(id)
            );
            if (availablePool.length === 0) {
              availablePool = fullPool;
              GameState.usedEvents = [];
            }

            // --- ä¿®æ­£é‡é»ï¼šå®‰å…¨æŠ½å–è¿´åœˆ ---
            let validEventFound = false;
            let attempts = 0;

            while (!validEventFound && attempts < 10) {
              const randId =
                availablePool[Math.floor(Math.random() * availablePool.length)];

              if (EventLibrary[randId]) {
                event = EventLibrary[randId];
                GameState.usedEvents.push(randId);
                validEventFound = true;
              } else {
                console.error("ç™¼ç¾ç„¡æ•ˆçš„äº‹ä»¶ ID:", randId); // åœ¨æ§åˆ¶å°å ±éŒ¯ï¼Œä½†ä¸å¡æ­»éŠæˆ²
                // å¾æš«æ™‚æ± ä¸­ç§»é™¤é€™å€‹å£æ‰çš„ IDï¼Œé¿å…ä¸‹æ¬¡é¦¬ä¸ŠåˆæŠ½åˆ°
                availablePool = availablePool.filter((id) => id !== randId);
                if (availablePool.length === 0) availablePool = fullPool;
              }
              attempts++;
            }
          }
        }

        // --- æœ€çµ‚é˜²å‘†ï¼šå¦‚æœ event é‚„æ˜¯ null (æ¥µç«¯ç‹€æ³)ï¼Œçµ¦ä¸€å€‹é è¨­äº‹ä»¶ ---
        if (!event) {
          console.warn("ç”Ÿæˆäº‹ä»¶å¤±æ•—ï¼Œä½¿ç”¨å‚™ç”¨äº‹ä»¶ã€‚");
          event = {
            text: "èµ°å»Šä¸Šä¸€ç‰‡æ­»å¯‚ï¼Œåªæœ‰é›»æµçš„å—¡å—¡è²...ä»€éº¼äº‹éƒ½æ²’ç™¼ç”Ÿã€‚",
            choices: [
              {
                text: "ç¹¼çºŒå·¡é‚",
                action: () => {
                  log("ä½ ç¹¼çºŒå‰å¾€ä¸‹ä¸€å€‹å·¡é‚é»ã€‚", "event");
                },
              },
            ],
          };
        }

        renderEvent(event);
      }

      function renderEvent(eventData) {
        const isCorrupted = Object.values(CorruptionEventLibrary).some(
          (e) => e.text === eventData.text
        );

        let prefix = "";
        if (isCorrupted) {
          prefix =
            "<span style='color:#ef5350; font-family:Impact; letter-spacing:1px;'>[ è­¦å‘Šï¼šæ€ç¶­é­åˆ°å…¥ä¾µ ]</span><br>";
        }

        // ç¢ºä¿ eventData.text å­˜åœ¨ï¼Œé˜²æ­¢å ±éŒ¯
        const eventText = eventData.text || "ï¼ˆç„¡æ³•è§£æçš„äº‹ä»¶ä¿¡è™Ÿ...ï¼‰";

        log(prefix + eventText, isCorrupted ? "insane" : "event", () => {
          const area = document.getElementById("choices-area");
          area.innerHTML = "";

          let choices = [...eventData.choices];
          if (GameState.sanity < 70) {
            choices.sort(() => Math.random() - 0.5);
          }

          choices.forEach((choice) => {
            // å®‰å…¨æª¢æŸ¥ï¼šç¢ºä¿ choice å°è±¡å®Œæ•´
            if (!choice) return;

            if (choice.reqClue && !GameState.clues.includes(choice.reqClue))
              return;

            // å¢åŠ  try-catch åŒ…è£¹æ¢ä»¶åˆ¤æ–·ï¼Œé˜²æ­¢ condition å‡½æ•¸å ±éŒ¯
            try {
              if (choice.condition && !choice.condition()) return;
            } catch (e) {
              console.warn("Condition check failed", e);
              return;
            }

            if (choice.sanityGate && GameState.sanity < choice.sanityGate)
              return;

            let isInsane = false;
            let btnText = choice.text || "???";

            if (isCorrupted || (GameState.sanity < 20 && Math.random() < 0.3)) {
              isInsane = true;
              if (!isCorrupted && GameState.sanity < 20)
                btnText = "æ­»æ­»æ­»æ­»æ­»æ­»æ­»æ­»";
            }

            createButton(
              btnText,
              () => {
                // ä½¿ç”¨ flag é˜²æ­¢é‡è¤‡æ¨é€²
                let hasAdvanced = false;

                try {
                  // 1. å…ˆå˜—è©¦è¨˜éŒ„æ—¥èªŒ (ç§»å…¥ try å€å¡Š)
                  const safeText = choice.text
                    ? choice.text.replace(/<[^>]*>?/gm, "")
                    : "è¡Œå‹•";
                  log(`> é¸æ“‡ï¼š${safeText}`, "system");

                  // 2. åŸ·è¡Œé¸é …é‚è¼¯
                  if (choice.action) {
                    choice.action();
                  }
                } catch (err) {
                  console.error("Event Action Error:", err);
                  // ç™¼ç”ŸéŒ¯èª¤æ™‚çµ¦äºˆæç¤ºï¼Œä½†ä¸ä¸­æ–·éŠæˆ²
                  log("ä½ è©¦åœ–åšå‡ºè¡Œå‹•ï¼Œä½†æ„è­˜æ¨¡ç³Šäº†ä¸€ç¬é–“...", "system");
                } finally {
                  // 3. ç„¡è«–æˆåŠŸæˆ–å¤±æ•—ï¼Œåªè¦éŠæˆ²æ²’çµæŸï¼Œéƒ½å˜—è©¦æ¨é€²æ™‚é–“
                  if (!GameState.isGameOver && !hasAdvanced) {
                    hasAdvanced = true;
                    setTimeout(() => {
                      // å†æ¬¡æª¢æŸ¥éŠæˆ²æ˜¯å¦åœ¨ç­‰å¾…æœŸé–“çµæŸ
                      if (!GameState.isGameOver) {
                        GameState.timeIndex++;
                        nextTimeBlock();
                      }
                    }, 1500 + Math.random() * 1000);
                  }
                }
              },
              isInsane
            );
          });

          area.classList.add("show");

          // åªæœ‰åœ¨éŠæˆ²æœªçµæŸä¸”æŒ‰éˆ•ç”Ÿæˆå¾Œæ‰å•Ÿå‹•è¨ˆæ™‚
          if (!GameState.isGameOver) {
            PanicSystem.start(10, () => {
              const allBtns = document.querySelectorAll("#choices-area button");
              allBtns.forEach((b) => (b.disabled = true));
              area.classList.remove("show");

              SoundSystem.play("damage");
              log(
                "ä½ å› ç‚ºæ¥µåº¦ææ‡¼è€Œå…¨èº«åƒµç¡¬ï¼Œç„¡æ³•åšå‡ºåæ‡‰ï¼è©­ç•°çš„å­˜åœ¨è¶æ©Ÿä¾µè•äº†ä½ ...",
                "danger"
              );
              changeStat("stamina", -25);
              changeStat("sanity", -15);

              if (!GameState.isGameOver) {
                setTimeout(() => {
                  GameState.timeIndex++;
                  nextTimeBlock();
                }, 2000);
              }
            });
          }
        });
      }
      window.initAudioAndStart = initAudioAndStart;
      window.openModal = openModal;
      window.closeModal = closeModal;
      window.CCTVSystem = CCTVSystem;
    </script>
  </body>
</html>
